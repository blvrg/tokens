<!DOCTYPE html>
<html>
<head>
    <title>btc tokens (xrc-20)</title>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
       * {
           font-family: 'VT323', monospace;
           font-size: 1.5rem;
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }
       body {
           width: 60%;
           margin: 0 auto;
           padding: 20px;
       }
       h1 {
           float:left;
           font-size:2rem;
           text-transform: uppercase;
       }
       #filter {
           float:right;
           display:none;
       }
       img {
           width: 50px;
           image-rendering: pixelated;
       }
       table {
           width: 100%;
           border-collapse: collapse;
       }
       th, td {
           padding: 10px;
           text-align: left;
           border-bottom: 1px solid #ccc;
       }
       th {
           background-color: #f2f2f2;
       }
    </style>
</head>
<body>
  <div id="nav">
    <h1>btc tokens (xrc-20)</h1>
    <select id="filter" onchange="getIssuances(this.value)">
        <option value="all">All</option>
        <option value="deploy" selected>Deploy</option>
        <option value="mint">Mint</option>
    </select>
  </div>

    <table id="result">
        <tr>
            <th>#</th>
            <th>Image</th>
            <th>Name</th>
            <th>Supply</th>
            <th>Max Mint</th>
        </tr>
    </table>
    <script>
        const MAX_RESULTS = 100;
        const API_URL = 'https://xchain.io/api/';

        function fetchIssuancesForBlock(blockNumber) {
            return fetch(API_URL + 'issuances/' + blockNumber)
                .then(response => response.json())
                .catch(error => {
                    console.error('Error:', error);
                    return 'Error occurred. See console for details.';
                });
        }

        function fetchAsset(asset) {
            return fetch(API_URL + 'asset/' + asset)
                .then(response => response.json())
                .catch(error => {
                    console.error('Error:', error);
                    return 'Error occurred. See console for details.';
                });
        }

        function getIssuances(filter = 'deploy') {
            let startBlock = 791121;
            let endBlock;

            fetch('https://blockchain.info/q/getblockcount')
                .then(response => response.text())
                .then(block => {
                    endBlock = parseInt(block);

                    document.getElementById('result').innerHTML = '<tr><th>#</th><th>Image</th><th>Name</th><th>Supply</th><th>Max Mint</th></tr>'; // Clear the results
                    currentResults = 0; // Reset results count

                    for(let i = endBlock; i >= startBlock && currentResults < MAX_RESULTS; i--) {
                        fetchIssuancesForBlock(i).then(issuances => {
                            issuances.data.forEach(issuance => {
                                let expectedStart = 'token:' + filter;
                                if((filter === 'all' && issuance.description.startsWith('token:')) ||
                                    (filter !== 'all' && issuance.description.startsWith(expectedStart)) &&
                                    currentResults < MAX_RESULTS) {
                                    // Increment result counter
                                    currentResults++;
                                    // Extract token parameters
                                    let params = issuance.description.split('|');

                                    // Create table row and fill out default fields
                                    let row = document.createElement('tr');
                                    let numCell = document.createElement('td');
                                    numCell.textContent = currentResults;
                                    let imgCell = document.createElement('td');
                                    let img = document.createElement('img');
                                    imgCell.appendChild(img);
                                    let nameCell = document.createElement('td');
                                    nameCell.textContent = params[1];
                                    let supplyCell = document.createElement('td');
                                    supplyCell.textContent = params[2];
                                    let maxMintCell = document.createElement('td');
                                    maxMintCell.textContent = params[3];

                                    // Check if we have an asset name or a base64 string
                                    if(params[4].startsWith('A')) {
                                        // Fetch asset information and extract base64 image from description
                                        fetchAsset(params[4]).then(asset => {
                                            let imageString = asset.description;
                                            if (imageString.toLowerCase().startsWith('stamp:')) {
                                                imageString = imageString.substring(6);
                                            }
                                            img.src = "data:image/png;base64," + imageString;
                                            row.appendChild(numCell);
                                            row.appendChild(imgCell);
                                            row.appendChild(nameCell);
                                            row.appendChild(supplyCell);
                                            row.appendChild(maxMintCell);
                                            document.getElementById('result').appendChild(row);
                                        });
                                    } else {
                                        img.src = "data:image/png;base64," + params[4];
                                        row.appendChild(numCell);
                                        row.appendChild(imgCell);
                                        row.appendChild(nameCell);
                                        row.appendChild(supplyCell);
                                        row.appendChild(maxMintCell);
                                        document.getElementById('result').appendChild(row);
                                    }
                                }
                            });
                        });
                    }
                })
                .catch(err => console.error('Error:', err));
        }

        window.onload = function() {
            getIssuances(); // Fetch issuances when the page loads
        };


    </script>

</body>
</html>
