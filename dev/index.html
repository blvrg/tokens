<!DOCTYPE html>
<html>
<head>
    <title>btc tokens (xrc-20)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¨</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        * {font-family: 'VT323', monospace;}
        body {width:60%; margin:0 auto; font-size: 1.5rem;}
        table {width:100%;}
        img {width:75px; height:75px; image-rendering:pixelated; cursor: pointer;}
        .header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem}
        td {text-align:center}
    </style>
</head>
<body>
    <div class="header">
        <h1>btc tokens (xrc-20)</h1>
        <select id="filterSelect">
            <option value="all">All</option>
            <option value="deploy">Deploy</option>
            <option value="mint">Mint</option>
        </select>
    </div>
    <table id="result"></table>
    <div id="loader"></div>

    <script>
        const SITE_URL = 'https://xchain.io/';
        const API_URL = 'https://xchain.io/api/';
        const dispenserCache = {};

        function createTableCell(elementType = 'td') {
            return document.createElement(elementType);
        }

        // Function to get a query parameter by name
        function getFirstQueryParam() {
            const urlParams = new URLSearchParams(window.location.search);
            for(let param of urlParams.keys()) {
                return param;
            }
            return null;
        }

        async function loadIssuances() {
            const filterSelect = document.getElementById('filterSelect');
            const filterType = filterSelect.value; // Get the selected filter type
            const data = await (await fetch('data.json')).json(); // Load data from local JSON file

            // Get the highest block number in your JSON data
            const lastBlock = data.reduce((highest, issuance) => Math.max(highest, issuance.block), 0);

            const nameQueryParam = getFirstQueryParam();

            // If nameQueryParam is not null, filter the data
            let filteredData = nameQueryParam 
                ? data.filter(issuance => issuance.name === nameQueryParam) 
                : data;

            // If filterType is not 'all', further filter the data
            filteredData = filterType !== 'all' 
                ? filteredData.filter(issuance => issuance.type === filterType) 
                : filteredData;

            renderIssuances(filteredData);

            // Start fetching new issuances from the API
            fetchNewIssuances(lastBlock + 1);
        }

        function renderIssuances(data) {
            result.innerHTML = '<tr><th>#</th><th>Image</th><th>Name</th><th>Type</th><th>Supply</th><th>Max Mint</th><th>Dispenser</th></tr>';

            for (let index = 0; index < data.length; index++) {
                const issuance = data[index];
                row.cells[6].innerHTML = issuance.dispenser.link ? `<a href="${issuance.dispenser.link}">${issuance.dispenser.text}</a>` : '';
            }

            loader.style.display = 'none';
        }

        const tokenImages = {};

        async function fetchNewIssuances(startBlock) {
            const endBlock = parseInt(await (await fetch('https://blockchain.info/q/getblockcount')).text());

            for(let i = startBlock; i <= endBlock; i++) {
                const issuances = await (await fetch(API_URL + 'issuances/' + i)).json();

                issuances.data.forEach(async (issuance) => {
                    if(['token:deploy', 'token:mint'].some(start => issuance.description.toLowerCase().startsWith(start))) {
                        let params = issuance.description.split('|');
                        const tokenType = issuance.description.toLowerCase().startsWith('token:deploy') ? 'deploy' : 'mint';  
                        let imageData;

                        if(tokenType === 'mint' && tokenImages[params[1]]) {
                            imageData = tokenImages[params[1]];
                        } else {
                            imageData = await getImageData(params[4], params[1]);
                        }

                        let newIssuance = {};
                        newIssuance['type'] = tokenType;
                        newIssuance['image'] = imageData;
                        newIssuance['name'] = params[1];
                        newIssuance['supply'] = params[2];
                        newIssuance['maxMint'] = issuance.description.toLowerCase().startsWith('token:deploy') ? params[3] : '';

                        const dispenserData = await (await fetch(`${API_URL}dispensers/${issuance.asset}?open`)).json();
                        let dispenserLink = '';
                        let dispenserText = '';

                        if (dispenserData && dispenserData.data && dispenserData.data.length > 0) {
                            dispenserLink = `${SITE_URL}tx/${dispenserData.data[0].tx_hash}`;
                            let giveRemaining = dispenserData.data[0].give_remaining;
                            let satoshiPrice = dispenserData.data[0].satoshi_price;
                            dispenserText = `${giveRemaining} @ ${satoshiPrice}`;
                        }

                        newIssuance['dispenser'] = dispenserLink ? { link: dispenserLink, text: dispenserText } : {};

                        // Call renderIssuances with the new issuance to update the page
                        renderIssuances([newIssuance]);
                    }
                });
            }
        }


        // Add event listener for the filter select
        document.getElementById('filterSelect').addEventListener('change', loadIssuances);
        window.onload = loadIssuances;  // Load issuances when the page loads

    </script>
</body>
</html>
