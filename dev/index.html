<!DOCTYPE html>
<html>
<head>
    <title>btc tokens (xrc-20)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¨</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        * {font-family: 'VT323', monospace;}
        body {width:60%; margin:0 auto; font-size: 1.5rem;}
        table {width:100%;}
        img {width:75px; height:75px; image-rendering:pixelated; cursor: pointer;}
        .header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem}
        td {text-align:center}
    </style>
</head>
<body>
<div class="header">
    <h1>btc tokens (xrc-20)</h1>
    <select id="filterSelect">
        <option value="all">All</option>
        <option value="deploy">Deploy</option>
        <option value="mint">Mint</option>
    </select>
</div>
<table id="result"></table>
<div id="loader"></div>

<script>
    const SITE_URL = 'https://xchain.io/';
    const API_URL = 'https://xchain.io/api/';
    const dispenserCache = {};
    const tokenImages = {}; // New variable to store token images

    function createTableCell(elementType = 'td') {
        return document.createElement(elementType);
    }

    // Function to get a query parameter by name
    function getFirstQueryParam() {
        const urlParams = new URLSearchParams(window.location.search);
        for(let param of urlParams.keys()) {
            return param;
        }
        return null;
    }

    async function getImageData(imgData, tokenName) {
        if (!imgData) return '';

        if (imgData.startsWith('A')) {
            const assetData = await (await fetch(API_URL + 'asset/' + imgData)).json();
            if (assetData && assetData.description && assetData.description.toLowerCase().startsWith('stamp:')) {
                imgData = assetData.description.replace(/stamp:/i, '');
            } else {
                imgData = assetData.description;
            }
        }
        const imageData = 'data:image/png;base64,' + imgData;
        tokenImages[tokenName] = imageData; // Store image data by token name

        return imageData;
    }

    async function loadIssuances() {
        const filterSelect = document.getElementById('filterSelect');
        const filterType = filterSelect.value; // Get the selected filter type
        const data = await (await fetch('data.json')).json(); // Load data from local JSON file
        const nameQueryParam = getFirstQueryParam();

        let filteredData = nameQueryParam 
            ? data.filter(issuance => issuance.name === nameQueryParam) 
            : data;

        filteredData = filterType !== 'all' 
            ? filteredData.filter(issuance => issuance.type === filterType) 
            : filteredData;

        const endBlock = parseInt(await (await fetch('https://blockchain.info/q/getblockcount')).text());
        const startBlock = filteredData[filteredData.length - 1].block_index;

        if (!document.getElementById('result').hasChildNodes()) {
            result.innerHTML = '<tr><th>#</th><th>Image</th><th>Name</th><th>Type</th><th>Supply</th><th>Max Mint</th><th>Dispenser</th></tr>';
        }

        for (let i = startBlock; i <= endBlock; i++) {
            const issuances = await (await fetch(`${API_URL}issuances/${i}`)).json();
            loader.textContent = `Loading block ${i} out of ${endBlock}`;

            issuances.data.forEach(async (issuance) => {
                if(['token:deploy', 'token:mint'].some(start => issuance.description.toLowerCase().startsWith(start))) {
                    let params = issuance.description.split('|'), row = document.createElement('tr');
                    const tokenType = issuance.description.toLowerCase().startsWith('token:deploy') ? 'deploy' : 'mint';  // determine the token type
                    let imageData;
                    if(tokenType === 'mint' && tokenImages[params[1]]) {
                        // If this is a mint and we have an image for this token name, use it
                        imageData = tokenImages[params[1]];
                    } else {
                        // Otherwise, fetch the image as normal
                        imageData = await getImageData(params[4], params[1]);
                    }

                    Array.from({ length: 7 }, () => createTableCell()).forEach((cell, i) => row.appendChild(cell));

                    row.cells[0].textContent = filteredData.length + 1; // currentResults in old code
                    row.cells[1].innerHTML = `<img src="${imageData}" onclick="window.open('${SITE_URL}asset/${issuance.asset}', '_blank')"/>`;
                    row.cells[2].innerHTML = `<a href="${SITE_URL}asset/${issuance.asset}" target="_blank">${params[1]}</a>`;
                    row.cells[3].textContent = tokenType;
                    row.cells[4].textContent = params[2];
                    row.cells[5].textContent = issuance.description.toLowerCase().startsWith('token:deploy') ? params[3] : ''; //max_mint for token:deploy

                    const dispenserData = dispenserCache[issuance.asset] || await (await fetch(`${API_URL}dispensers/${issuance.asset}?open`)).json();
                    dispenserCache[issuance.asset] = dispenserData;

                    let dispenserLink = '';
                    let dispenserText = '';
                    if (dispenserData?.data?.length > 0 && dispenserData.data[0].give_remaining > 0) {
                        dispenserLink = `${SITE_URL}tx/${dispenserData.data[0].tx_hash}`;
                        const { give_remaining: giveRemaining, satoshi_price: satoshiPrice } = dispenserData.data[0];
                        dispenserText = `${giveRemaining} @ ${satoshiPrice}`; // Format the text as 'x @ y'
                    }

                    row.cells[6].innerHTML = dispenserLink ? `<a href="${dispenserLink}" target="_blank">${dispenserText}</a>` : '';
                    row.setAttribute('id', issuance.asset); // Add ID to the row for referencing

                    result.appendChild(row);
                    filteredData.push(issuance); // add complete issuance data to results array
                }
            });

            if(i === endBlock) {
                loader.style.display = 'none';
            }
        }
    }

    // Add event listener for the filter select
    document.getElementById('filterSelect').addEventListener('change', loadIssuances);
    window.onload = loadIssuances;  // Load issuances when the page loads
</script>
</body>
</html>
